//devin87@qq.com
//build:2017/03/21 10:20:45
!function(t,e){"use strict";function r(t){var e=u.Lang;switch(t){case H:return e.status_ready;case N:return e.status_processing;case O:return e.status_complete;case P:return e.status_skip;case z:return e.status_cancel;case q:return e.status_error}return t}function a(){var e=t.XMLHttpRequest;e&&(new e).upload&&t.FormData&&(x=!0);var r=document.createElement("input");r.type="file",L=!!r.files,b=x}function i(t,e){var r=t.lastIndexOf(e);return-1!=r?t.slice(r):""}function n(t){if(t){for(var e=t.split(","),r={},a=0,i=e.length;i>a;a++)r[e[a]]=!0;return r}}function s(t,e){t.attachEvent?t.attachEvent("onload",e):t.addEventListener("load",e,!1)}function o(t,e,r){if(e&&!(0>=e)){var a,i=Date.now();if(r>=e)return a=i-t.startTime,a?t.avgSpeed=Math.min(Math.round(1e3*e/a),e):t.speed||(t.avgSpeed=t.speed=e),t.time=a||0,void(t.endTime=i);a=i-t.lastTime,200>a||(t.speed=Math.min(Math.round(1e3*(r-t.loaded)/a),t.total),t.lastTime=i)}}function u(t){var e=this;e.guid=t.guid||"uploader"+ ++E,e.url=t.url,e.dataType=t.dataType||"json",e.data=t.data,e.target=t.target,e.html5=x&&!!l(t.html5,!0),e.multiple=L&&e.html5&&!!l(t.multiple,!0),e.clickTrigger=b&&!!l(t.clickTrigger,!0),e.workerThread=e.html5?t.workerThread||1:1,e.workerIdle=e.workerThread,e.auto=t.auto!==!1,e.upName=t.upName||"upfile",e.allows=n(t.allows),e.disallows=n(t.disallows),e.chunkSize=t.chunkSize||2097152,e.isSlice=!!t.isSlice,e.isQueryState=!!l(t.isQueryState,e.isSlice),e.isMd5=!!l(t.isMd5,e.isSlice),e.isUploadAfterHash=t.isUploadAfterHash!==!1,e.container=t.container||document.body,t.getPos&&(e.getPos=t.getPos);var r=t.UI||{};r.init&&(e.init=r.init),r.draw&&(e.draw=r.draw),r.update&&(e.update=r.update),r.over&&(e.over=r.over),e.fns=t.on||{},e.ops=t,e.list=[],e.map={},e.index=0,e.started=!1,e._init()}var l=Q.def,d=Q.fire,c=Q.extend,p=Q.getFirst,f=Q.getLast,h=JSON.parse,m=Q.createEle,v=Q.parseHTML,g=Q.setOpacity,_=Q.getOffset,y=Q.md5File,w=Q.event,T=w.add,k=w.trigger,S=w.stop,x=!1,L=!1,b=!1,E=0,I=0,M=0,H=0,N=1,O=2,P=-1,z=-2,q=-3;u.prototype={constructor:u,_init:function(){var t=this;if(!t._inited){t._inited=!0;var r=t.guid,a=t.target,i=t.container,n=m("div","upload-input "+r);if(i.appendChild(n),t.boxInput=n,!t.html5){var o="upload_iframe_"+r,u='<iframe class="u-iframe" name="'+o+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+o+'"></form>',l=m("div","upload-html4 "+r,u);i.appendChild(l);var d=p(l),c=f(l);t.iframe=d,t.form=c,s(d,function(){if(0==t.workerIdle){var r;try{r=d.contentWindow.document.body.innerHTML}catch(a){}t.complete(e,O,r)}})}return t.clickTrigger?T(a,"click",function(e){t.fire("select",e)!==!1&&(t.resetInput(),k(t.inputFile,"click"))}):(T(n,"click",function(e){t.fire("select",e)===!1&&S(e)}),g(n,0),t.resetInput()),t.fire("init"),t.run("init")}},resetInput:function(){var t=this,e=t.boxInput;e.innerHTML='<input type="file" name="'+t.upName+'" style="'+(t.clickTrigger?"visibility: hidden;":"font-size:100px;")+'"'+(t.multiple?' multiple="multiple"':"")+">";var r=p(e);return T(r,"change",function(e){t.add(this),t.html5||t.resetInput()}),t.inputFile=r,t.updatePos()},updatePos:function(t){var e=this;if(e.clickTrigger)return e;var r=e.getPos||_,a=e.boxInput,i=p(a),n=e.target,s=n.offsetWidth,o=n.offsetHeight,u=0==s?{left:-1e4,top:-1e4}:r(n);return a.style.width=i.style.width=s+"px",a.style.height=i.style.height=o+"px",a.style.left=u.left+"px",a.style.top=u.top+"px",t&&(a.style.zIndex=++M),e},fire:function(t,e,r){if(!r)return d(this.fns[t],this,e);var a=this.fns[t+"Async"];return a?d(a,this,e,r):void r(d(this.fns[t],this,e))},run:function(t,e){var r=this[t];return r&&d(r,this,e),this},addTask:function(t,e){if(t||e){var r,a;e?(r=e.name||e.fileName,a=e.size||e.fileSize):(r=i(t.value,"\\").slice(1)||t.value,a=-1);var n=this,s=i(r,".").toLowerCase(),o=n.disallows&&n.disallows[s]||n.allows&&!n.allows[s],u={id:++I,name:r,ext:s,size:a,input:t,file:e,state:o?P:H};return o&&(u.disabled=!0),n.fire("add",u,function(t){t===!1||u.disabled||(u.index=n.list.length,n.list.push(u),n.map[u.id]=u,n.run("draw",u),n.auto&&n.start())}),u}},add:function(t){var r=this;if("INPUT"==t.tagName){var a=t.files;if(a)for(var i=0,n=a.length;n>i;i++)r.addTask(t,a[i]);else r.addTask(t)}else r.addTask(e,t)},addList:function(t){for(var e=0,r=t.length;r>e;e++)this.add(t[e])},get:function(t){return t!=e?this.map[t]:void 0},cancel:function(t,e){var r=this,a=r.get(t);if(a){var i=a.state;if(i!=H&&i!=N)return r;if(i==N){var n=a.xhr;if(n)return n.abort(),r;r.iframe.contentWindow.location="about:blank"}return e?r:r.complete(a,z)}},remove:function(t){var e=this.get(t);e&&(e.state==N&&this.cancel(t),e.deleted=!0,this.fire("remove",e))},start:function(){var t=this,e=t.workerIdle,r=t.list,a=t.index,i=r.length;if(t.started||(t.started=!0),0>=i||a>=i||0>=e)return t;var n=r[a];return t.index++,t.upload(n)},upload:function(t){var e=this;return!t||t.state!=H||t.skip?e.start():(t.url=e.url,e.workerIdle--,e.fire("upload",t,function(r){return r===!1?e.complete(t,P):void(e.html5&&t.file?e._upload_html5_ready(t):t.input?e._upload_html4(t):e.complete(t,P))}),e)},queryState:function(t,e){var r=this,a=r.url,i=new XMLHttpRequest;return t.queryUrl=a+(-1==a.indexOf("?")?"?":"&")+"action=query&hash="+(t.hash||t.name),r.fire("sliceQuery",t),i.open("GET",t.queryUrl),i.onreadystatechange=function(){if(4==i.readyState){var a,n;if(i.status>=200&&i.status<400)if(a=i.responseText,"ok"===a?n={ret:1}:a&&(n=h(a)),n&&"number"!=typeof n||(n={ret:0,start:n}),t.response=a,t.json=n,1==n.ret)t.queryOK=!0,r.cancel(t.id,!0).complete(t,O);else{var s=+n.start||0;s!=Math.floor(s)&&(s=0),t.sliceStart=s}d(e,r,i)}},i.onerror=function(){d(e,r,i)},i.send(null),r},_upload_html5_ready:function(t){var e=this,r=function(){t.state!=O&&(e.isSlice?e._upload_slice(t):e._upload_html5(t))},a=function(r){e.fire("hash",t,function(){t.hash&&e.isQueryState&&t.state!=O?e.queryState(t,r):r()})},i=function(r){if(e.isMd5&&y){var i=e.fns.hashProgress;y(t.file,function(e,i){t.hash=e,t.timeHash=i,a(r)},function(r){d(i,e,t,r)})}else a(r)};return e.isUploadAfterHash?i(r):(r(),i()),e},_process_params:function(t,e){this.data&&Object.forEach(this.data,e),t.data&&Object.forEach(t.data,e)},_upload_html5:function(t){var e=this,r=new XMLHttpRequest;t.xhr=r,r.upload.addEventListener("progress",function(r){e.progress(t,r.total,r.loaded)},!1),r.addEventListener("load",function(r){e.complete(t,O,r.target.responseText)},!1),r.addEventListener("error",function(){e.complete(t,q)},!1),r.addEventListener("abort",function(){e.complete(t,z)},!1);var a=new FormData;e._process_params(t,function(t,e){a.append(t,e)}),a.append("fileName",t.name),a.append(e.upName,t.blob||t.file,t.name),r.open("POST",t.url),e.fire("send",t,function(i){return i===!1?e.complete(t,P):(r.send(a),void e._afterSend(t))})},_upload_html4:function(t){var e=this,r=e.form,a=t.input;return a._uploaded?e.complete(t,O):(a._uploaded=!0,a.name=e.upName,r.innerHTML="",r.appendChild(a),r.action=t.url,e._process_params(t,function(t,e){r.appendChild(v('<input type="hidden" name="'+t+'" value="'+e+'">'))}),void e.fire("send",t,function(a){return a===!1?e.complete(t,P):(r.submit(),void e._afterSend(t))}))},_afterSend:function(t){t.lastTime=t.startTime=Date.now(),t.state=N,this._lastTask=t,this.progress(t)},progress:function(t,e,r){e||(e=t.size),(!r||0>r)&&(r=0);var a=t.state||H;r>e&&(r=e),r>0&&a==H&&(t.state=a=N);var i=a==O;i&&(e=r=t.size),o(t,e,r),t.total=e,t.loaded=r,this.fire("progress",t),this.run("update",t)},_process_response:function(t,e){t.response=e,e&&"json"==this.dataType&&(t.json=h(e))},complete:function(t,r,a){var i=this;return t||1!=i.workerThread||(t=i._lastTask),t&&(r!=e&&(t.state=r),t.state!=N&&r!=O||(t.state=O,i.progress(t,t.size,t.size)),a!==e&&i._process_response(t,a)),r==z&&i.fire("cancel",t),i.fire("complete",t),i.run("over",t).run("update",t),i.workerIdle++,i.started&&i.start(),i}},u.extend=function(t,e){c(u.prototype,t,e)},a(),c(u,{support:{html5:x,multiple:L},READY:H,PROCESSING:N,COMPLETE:O,SKIP:P,CANCEL:z,ERROR:q,Lang:{status_ready:"准备中",status_processing:"上传中",status_complete:"已完成",status_skip:"已跳过",status_cancel:"已取消",status_error:"已失败"},getStatusText:r}),Q.Uploader=u}(window);